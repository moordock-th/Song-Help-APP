<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Songblock Pro - Lead Sheet Edition</title>
    <style>
        :root {
            --primary: #667eea;
            --chord-size: 45px;
            --font-size: 16px;
        }

        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
            margin: 0; padding: 0;
            color: #333;
        }

        .app {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
            display: flex; flex-direction: column;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; padding: 15px; text-align: center;
        }

        .tabs {
            display: flex;
            background: #eee;
            border-bottom: 1px solid #ccc;
        }

        .tab {
            flex: 1; padding: 12px; text-align: center;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }

        .tab.active {
            background: white; color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .controls {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            background: #f8f9fa; padding: 15px; border-bottom: 1px solid #ddd;
        }

        .control-group { display: flex; flex-direction: column; gap: 5px; }
        .control-group label { font-size: 11px; font-weight: bold; color: #666; }

        .content { padding: 20px; flex: 1; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Meta Inputs f√ºr Tonart & Tuning */
        .meta-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .meta-inputs input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        textarea {
            width: 100%; height: 140px; padding: 10px; border: 1px solid #ccc;
            border-radius: 4px; font-family: monospace; font-size: 14px; margin-bottom: 15px;
            box-sizing: border-box;
        }

        .buttons { display: flex; gap: 10px; margin-bottom: 20px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; color: white; }
        .btn-primary { background: var(--primary); }
        .btn-secondary { background: #6c757d; }

        /* --- VORSCHAU --- */
        .preview { line-height: 1.2; background: white; }
        
        .print-meta-header {
            display: none; /* Nur beim Drucken sichtbar */
            border-bottom: 2px solid #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
        }

        .line {
            display: flex; flex-wrap: wrap;
            padding-top: calc(var(--chord-size) * 1.45); 
            margin-bottom: 10px;
        }

        .word-wrapper { position: relative; display: inline-block; margin-right: 0.3em; }
        .chord-box {
            position: absolute; bottom: 100%; left: 0;
            width: var(--chord-size); margin-bottom: 2px; pointer-events: none;
        }

        .chord-name {
            display: block; font-weight: bold;
            font-size: calc(var(--chord-size) * 0.35);
            color: var(--primary); text-align: left; margin-bottom: 1px;
        }

        .chord-svg { width: var(--chord-size); height: auto; display: block; }
        .word-text { font-size: var(--font-size); white-space: nowrap; }

        .lib-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 15px; text-align: center;
        }
        .lib-item { padding: 10px; border: 1px solid #eee; border-radius: 4px; background: #fff; }

        @media print {
            .header, .tabs, .controls, .meta-inputs, textarea, .buttons { display: none !important; }
            .app { box-shadow: none; width: 100%; max-width: 100%; }
            .print-meta-header { display: block !important; }
            .line { page-break-inside: avoid; }
            .lib-item { border: 0.5px solid #ccc; }
        }
    </style>
</head>
<body>

<div class="app">
    <div class="header"><h1>üé∏ Songblock Pro</h1></div>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('editor')">Editor</div>
        <div class="tab" onclick="switchTab('library')">Bibliothek</div>
    </div>

    <div class="content">
        <div id="editor" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label>Akkorde (Gr√∂√üe)</label>
                    <input type="range" id="chordSize" min="25" max="75" value="40" oninput="updateLayout()">
                </div>
                <div class="control-group">
                    <label>Text (Gr√∂√üe)</label>
                    <input type="range" id="textSize" min="10" max="30" value="16" oninput="updateLayout()">
                </div>
            </div>

            <div class="meta-inputs">
                <input type="text" id="songTitle" placeholder="Song Titel & Tonart (z.B. Hotel California - Hm)" oninput="renderSong()">
                <input type="text" id="songTuning" placeholder="Tuning (z.B. Eb Standard / Capo 2)" oninput="renderSong()">
            </div>

            <textarea id="input" placeholder="Tippe Text & Akkorde..." oninput="renderSong()">
G        D        emoll    C
Dies ist dein Arrangement.
Eb       G#       asus2    Cadd9
Alles kompakt auf einer Seite.</textarea>

            <div class="buttons">
                <button class="btn-primary" onclick="window.print()">üñ®Ô∏è Drucken / PDF</button>
                <button class="btn-secondary" onclick="clearEditor()">üóëÔ∏è L√∂schen</button>
            </div>

            <div id="output" class="preview"></div>
        </div>

        <div id="library" class="tab-content">
            <div id="libOutput" class="lib-grid"></div>
        </div>
    </div>
</div>

<script>
    const patterns = {
        // DUR & HALBT√ñNE
        "C": "x32010", "C#": "x46664", "Db": "x46664", "D": "xx0232", "D#": "x68886", "Eb": "x68886", "E": "022100", "F": "133211", "F#": "244322", "Gb": "244322", "G": "320003", "G#": "466544", "Ab": "466544", "A": "x02220", "A#": "x13331", "Bb": "x13331", "B": "x24442",
        // MOLL
        "Cm": "x35543", "C#m": "x46654", "Dbm": "x46654", "Dm": "xx0231", "D#m": "x68876", "Ebm": "x68876", "Em": "022000", "Fm": "133111", "F#m": "244222", "Gbm": "244222", "Gm": "355333", "G#m": "466444", "Abm": "466444", "Am": "x02210", "A#m": "x13321", "Bbm": "x13321", "Bm": "x24432",
        // SPEZIAL (sus2, sus4, add9, maj7, 7, 5)
        "C7": "x32310", "D7": "xx0212", "E7": "020100", "G7": "320001", "A7": "x02020", "B7": "x21202",
        "Cmaj7": "x32000", "Dmaj7": "xx0222", "Emaj7": "021100", "Fmaj7": "x33210", "Gmaj7": "320002", "Amaj7": "x02120", "Bmaj7": "x24342",
        "Csus2": "x30033", "Dsus2": "xx0230", "Asus2": "x02200", "Esus2": "024400",
        "Csus4": "x33011", "Dsus4": "xx0233", "Esus4": "022200", "Asus4": "x02230", "Gsus4": "330033",
        "Cadd9": "x32030", "Dadd9": "xx0252", "Gadd9": "320005", "Aadd9": "x02420",
        "C5": "x355xx", "D5": "x577xx", "E5": "022xxx", "G5": "355xxx", "A5": "x022xx", "B5": "x244xx"
    };

    function updateLayout() {
        document.documentElement.style.setProperty('--chord-size', document.getElementById('chordSize').value + 'px');
        document.documentElement.style.setProperty('--font-size', document.getElementById('textSize').value + 'px');
    }

    function switchTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.currentTarget.classList.add('active');
        if (tabId === 'library') renderLibrary();
    }

    function findChord(input) {
        if (!input) return null;
        let clean = input.trim().toLowerCase()
            .replace(/moll/g, 'm').replace(/min/g, 'm');
        let match = Object.keys(patterns).find(key => key.toLowerCase() === clean);
        return match || null;
    }

    function createSvg(pattern) {
        const frets = pattern.split('');
        let dots = '';
        frets.forEach((fret, i) => {
            if (fret !== 'x' && fret !== '0') {
                dots += `<circle cx="${5+(i*7)}" cy="${10+(parseInt(fret, 16)*8)}" r="2.5" fill="black" />`;
            }
        });
        return `<svg class="chord-svg" viewBox="0 0 45 60"><rect x="5" y="10" width="35" height="40" fill="white" stroke="#333" stroke-width="0.5"/>${[10, 18, 26, 34, 42, 50].map(y => `<line x1="5" y1="${y}" x2="40" y2="${y}" stroke="#333" stroke-width="0.5"/>`).join('')}${[5, 12, 19, 26, 33, 40].map(x => `<line x1="${x}" y1="10" x2="${x}" y2="50" stroke="#333" stroke-width="0.5"/>`).join('')}${dots}</svg>`;
    }

    function renderSong() {
        const input = document.getElementById('input').value;
        const title = document.getElementById('songTitle').value;
        const tuning = document.getElementById('songTuning').value;
        const output = document.getElementById('output');
        
        let html = `<div class="print-meta-header">
                        <h1 style="margin:0;">${title || 'Unbenannter Song'}</h1>
                        <p style="margin:5px 0; font-weight:bold;">Tuning: ${tuning || 'Standard'}</p>
                    </div>`;

        let used = new Set();
        const lines = input.split('\n');

        lines.forEach(line => {
            if (!line.trim()) { html += '<div style="height:1.2em"></div>'; return; }
            html += '<div class="line">';
            const segments = line.split(/(\s+)/);
            segments.forEach(seg => {
                let chordMatch = findChord(seg);
                if (chordMatch) {
                    html += `<div class="word-wrapper"><div class="chord-box"><span class="chord-name">${chordMatch}</span>${createSvg(patterns[chordMatch])}</div><span class="word-text">&nbsp;&nbsp;</span></div>`;
                    used.add(chordMatch);
                } else {
                    html += `<div class="word-wrapper"><span class="word-text">${seg.replace(/ /g, '&nbsp;')}</span></div>`;
                }
            });
            html += '</div>';
        });

        if (used.size > 0) {
            html += `<div style="margin-top:40px; border-top:2px solid #eee; padding-top:20px;"><h3>Verwendete Griffe</h3><div class="lib-grid">`;
            Array.from(used).sort().forEach(c => {
                html += `<div class="lib-item"><span class="chord-name" style="text-align:center;">${c}</span>${createSvg(patterns[c])}</div>`;
            });
            html += `</div></div>`;
        }
        output.innerHTML = html;
    }

    function renderLibrary() {
        const libOutput = document.getElementById('libOutput');
        if (libOutput.innerHTML !== "") return;
        libOutput.innerHTML = Object.keys(patterns).sort().map(c => `
            <div class="lib-item">
                <span class="chord-name" style="text-align:center;">${c}</span>
                ${createSvg(patterns[c])}
            </div>
        `).join('');
    }

    function clearEditor() {
        document.getElementById('input').value = '';
        document.getElementById('songTitle').value = '';
        document.getElementById('songTuning').value = '';
        renderSong();
    }

    updateLayout();
    renderSong();
</script>
</body>
</html>
